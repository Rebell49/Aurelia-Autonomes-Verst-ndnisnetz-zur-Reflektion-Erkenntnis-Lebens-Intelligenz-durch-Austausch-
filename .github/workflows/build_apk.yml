name: Build APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì¶ Repository auschecken
      uses: actions/checkout@v4

    - name: üêç Python 3.11 installieren
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ‚öôÔ∏è Android SDK installieren (Command Line Tools)
      run: |
        mkdir -p $HOME/.android/cmdline-tools
        cd $HOME/.android/cmdline-tools
        curl -o sdk.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip sdk.zip
        rm sdk.zip
        mv cmdline-tools latest

    - name: üîß Android-Umgebungsvariablen setzen
      run: |
        echo "ANDROID_HOME=$HOME/.android" >> $GITHUB_ENV
        echo "$HOME/.android/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/.android/platform-tools" >> $GITHUB_PATH

    - name: ‚úÖ Android SDK Lizenzen akzeptieren
      run: yes | sdkmanager --licenses || true

    - name: üîÑ pip & essentielle Pakete installieren
      run: |
        python -m pip install --upgrade pip
        pip install pipreqs build jinja2 toml packaging colorama appdirs
        
    - name: üîß Libtool & autotools vollst√§ndig installieren
      run: |
        sudo apt-get update
        sudo apt-get install -y libtool m4 automake autoconf

    - name: üßπ BOM-Zeichen aus .py-Dateien entfernen
      run: |
        echo "Entferne BOM aus .py-Dateien..."
        find . -name "*.py" -exec sed -i '1s/^\xEF\xBB\xBF//' {} +

    - name: üìÑ requirements.txt automatisch erzeugen
      run: pipreqs . --force --encoding=utf-8

    - name: üîÅ buildozer.spec mit requirements.txt aktualisieren
      run: |
        echo "Aktualisiere buildozer.spec..."
        REQS=$(paste -sd, requirements.txt)
        sed -i "s/^requirements = .*/requirements = $REQS/" buildozer.spec || echo "requirements = $REQS" >> buildozer.spec

    - name: üì¶ requirements installieren
      run: pip install -r requirements.txt

    - name: üß∞ Systemabh√§ngigkeiten installieren
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          zip unzip openjdk-17-jdk python3-pip \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev zlib1g-dev \
          gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-libav \
          libmtdev-dev libgl1-mesa-dev libgles2-mesa-dev libusb-dev libspnav-dev \
          libasound2-dev libffi-dev libjpeg-dev \
          git-core python3-setuptools python3-wheel libstdc++6 \
          pkg-config autoconf automake libtool cmake libncurses-dev

    - name: ‚òï Java-Version pr√ºfen
      run: java -version

    - name: üõ†Ô∏è Buildozer & python-for-android installieren
      run: |
        pip install --upgrade Cython virtualenv buildozer
        if [ ! -f buildozer.spec ]; then buildozer init; fi
        if [ ! -d .buildozer/android/platform/python-for-android ]; then
          git clone https://github.com/kivy/python-for-android.git .buildozer/android/platform/python-for-android
        fi

    - name: üõ†Ô∏è Fix libffi configure.ac f√ºr LT_SYS_SYMBOL_USCORE
      run: |
        set -e
        TARGET_DIR=$(find .buildozer -type d -name "libffi" | head -n 1)
        echo "Gefundenes libffi-Verzeichnis: $TARGET_DIR"
           if [ -f "$TARGET_DIR/configure.ac" ]; then
            sed -i '/AC_INIT/a m4_pattern_allow([LT_SYS_SYMBOL_USCORE])' "$TARGET_DIR/configure.ac"
            cd "$TARGET_DIR"
          libtoolize --force
         aclocal -I m4 || aclocal
         autoreconf --install --force --verbose
         else
         echo "Fehler: configure.ac wurde nicht gefunden."
         exit 1
         fi

    - name: üß™ APK bauen (Release)
      run: |
        yes | buildozer android release

    - name: ‚¨ÜÔ∏è APK als Artefakt hochladen
      uses: actions/upload-artifact@v4
      with:
        name: Aurelia-APK
        path: bin/*.apk
